%HEADER%
%VAR_HEADER_UPLOT%

  <div class="content-wrapper">
    <div id="content" class="container my-5">
      <div class="card card-accent-dark mb-5 pb-0 shadow-sm rounded">
        <div class="card-body bg-light pb-1 rounded">
          <h5 class="card-title">Pump Control Settings</h5>
        </div>
        <div class="card-body">
          <div class="row row-cols-3 row-cols-md-3">
            <div class="col-md-5 mb-4">
              <div><strong>Control Method:</strong> <span id="controlMethod">--</span></div>
              <div><strong>Profile:</strong> <span id="profileName">--</span></div>
              <div><strong>Phase:</strong> <span id="phaseName">--</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card card-accent-dark mb-5 pb-0 shadow-sm rounded">
        <div class="card-body bg-light pb-1 rounded">
          <h5 class="card-title">Brew Telemetry</h5>
        </div>
        <div class="card-body">
          <div id="telemetryLegend" class="mt-2"></div>
          <div id="telemetryChart" style="width: 100%; height: 300px;"></div>
        </div> 
      </div> 
    </div>
  </div>

  <template>
    <div class="chart-wrapper">
      <div ref="chartRef" style="width: 100%; height: 300px;"></div>
    </div>
  </template>

  <script>

    document.addEventListener("DOMContentLoaded", () => {
    const chartRef = document.getElementById("telemetryChart");
    const legendRef = document.getElementById("telemetryLegend");

    const data = [
      [0.0], // time
      [0.0], // inputPressure
      [0.0], // setPressure
      [0.0], // pumpFlowRate
      [0.0], // setPumpFlowRate
      [0.0], // currBrewWeight
      [0.0], // dimmerPower
    ];

    const options = {
      width: chartRef.clientWidth,
      height: 300,
      plugins: [tooltipsPlugin()],
      series: [
        { 
          label: "Time (s)" 
        },
        { 
          label: "Input Pressure", 
          stroke: "red", 
          points: { 
            show: false 
          }  
        },
        { 
          label: "Set Pressure", 
          stroke: "darkred", 
          dash: [5, 5], 
          points: { 
            show: false 
          }  
        },
        { 
          label: "Pump Flow", 
          stroke: "green", 
          points: { 
            show: false 
          }  
        },
        { 
          label: "Set Pump Flow", 
          stroke: "darkgreen", 
          dash: [5, 5], 
          points: { 
            show: false 
          }  
        },
        { 
          label: "Weight Brewed", 
          stroke: "blue", 
          scale: "right", 
          points: { 
            show: false 
          }  
        },
        { 
          label: "Pump Power Pct", 
          stroke: "purple", 
          scale: "right", 
          points: { 
            show: false 
          }  
        },
      ],
      scales: {
        x: { 
          time: false, 
          show: true,
        },
        y: { 
          auto: false,
          range: [0, 11],
          show: true,
        },        
        right: { 
          auto: false,
          range: [0, 110],
          show: true,
          grid: false,
        },   
      },
      axes: [
        {
          label: "Time (s)",
          values: (u, ticks) => ticks.map(v => v.toFixed(1)),  // 1 decimal place
        },
        { 
          label: "Pressure/Flow"
        },                       
        { 
          label: "Weight/Power Pct",
          scale: "right", 
          side: 1 
        }, 
      ],
      legend: {
        show: false,
      },
    };

    const chart = new uPlot(options, data, chartRef);

    function createLegend(series, container) {
      container.innerHTML = "";
      for (let i = 0; i < series.length; i++) {
        const s = series[i];

        const item = document.createElement("div");
        item.style.display = "inline-block";
        item.style.marginRight = "15px";

        const swatch = document.createElement("span");
        swatch.style.display = "inline-block";
        swatch.style.width = "12px";
        swatch.style.height = "12px";
        swatch.style.marginRight = "6px";
        swatch.style.verticalAlign = "middle";
        swatch.style.backgroundColor = s.stroke || "#000";
        swatch.style.border = "1px solid #aaa";

        if (s.dash) {
          swatch.style.backgroundImage = `repeating-linear-gradient(
            90deg,
            ${s.stroke},
            ${s.stroke} 3px,
            white 3px,
            white 6px
          )`;
          swatch.style.backgroundSize = "6px 100%";
        }

        const label = document.createElement("span");
        label.textContent = s.label + ": ";

        const value = document.createElement("span");
        value.id = `live-value-${i}`;
        value.textContent = "--";

        item.appendChild(swatch);
        item.appendChild(label);
        item.appendChild(value);
        container.appendChild(item);
      }
    }

    createLegend(options.series, legendRef);

    function tooltipsPlugin() {
      let tooltips = [];

      function init(u) {
        const over = u.over;

        // Create a tooltip div for each series, should probably change this to a single combined tooltip
        for (let i = 1; i < u.series.length; i++) {
          const tt = document.createElement("div");
          tt.className = "uplot-tooltip";
          tt.style.position = "absolute";
          tt.style.pointerEvents = "none";
          tt.style.background = "rgba(0,0,0,0.7)";
          tt.style.color = "#fff";
          tt.style.fontSize = "10px";
          tt.style.padding = "2px 4px";
          tt.style.borderRadius = "3px";
          tt.style.display = "none";
          tt.style.whiteSpace = "nowrap";

          over.appendChild(tt);
          tooltips.push(tt);
        }

        // Hide all tooltips on mouse leave
        over.addEventListener("mouseleave", () => {
          tooltips.forEach(tt => tt.style.display = "none");
        });
      }

      function setCursor(u) {
        const { idx } = u.cursor;

        for (let i = 1; i < u.series.length; i++) {
          const tt = tooltips[i - 1];
          const s = u.series[i];

          const xVal = u.data[0][idx];
          const yVal = u.data[i][idx];

          if (xVal == null || yVal == null || !s.show) {
            tt.style.display = "none";
            continue;
          }

          const xPos = u.valToPos(xVal, 'x');
          const yPos = u.valToPos(yVal, s.scale);

          tt.textContent = `${s.label || "Series " + i}: ${yVal.toFixed(2)}`;
          tt.style.left = `${xPos + 10}px`;
          tt.style.top = `${yPos - 10}px`;
          tt.style.display = "block";
        }
      }

      return {
        hooks: {
          init,
          setCursor,
        }
      };
    }

    let isBrewing = false;
    let startTime = null;

    const eventSource = new EventSource("/events");

    eventSource.addEventListener("brew_state", (event) => {
      const state = event.data;

      if (state === "start") {
        isBrewing = true;

        for (let i = 0; i < data.length; i++) data[i].length = 0;
        chart.setData(data);
      } else if (state === "stop") {
        isBrewing = false;
      }

      // Update legend live values
      const latestIndex = data[0].length - 1;
      for (let i = 0; i < data.length; i++) {
        const val = data[i][latestIndex];
        const el = document.getElementById(`live-value-${i}`);
        if (el) el.textContent = val !== null && val !== undefined ? val.toFixed(2) : "--";
      }
    });

    eventSource.addEventListener("brew_event", (event) => {
      if (!isBrewing) return;

      try {
        const json = JSON.parse(event.data);

        data[0].push(json.currBrewTime ?? 0);
        data[1].push(json.inputPressure ?? null);
        data[2].push(json.setPressure ?? null);
        data[3].push(json.pumpFlowRate ?? null);
        data[4].push(json.setPumpFlowRate ?? null);
        data[5].push(json.currBrewWeight ?? null);
        data[6].push(json.dimmerPower ?? null);

        // Keep only last 1000 points
        if (data[0].length > 1000) {
          for (let i = 0; i < data.length; i++) data[i].shift();
        }

        // Update UI elements
        if (json.control) document.getElementById("controlMethod").textContent = json.control;
        if (json.profile) document.getElementById("profileName").textContent = json.profile;
        if (json.phase) document.getElementById("phaseName").textContent = json.phase;
        
        //console.log("data before update", JSON.stringify(data));
        chart.setData(data);

        // Update legend live values again
        const latestIndex = data[0].length - 1;
        for (let i = 0; i < data.length; i++) {
          const val = data[i][latestIndex];
          const el = document.getElementById(`live-value-${i}`);
          if (el) el.textContent = val !== null && val !== undefined ? val.toFixed(2) : "--";
        }
      } catch (err) {
        console.warn("Bad JSON:", event.data);
      }
    });
  });
  </script>
  </div>

</div>

</body>
</html>